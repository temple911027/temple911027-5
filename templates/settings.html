<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè¨­å®š</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body{padding:15px;font-family:sans-serif}
        label{display:block;margin-top:10px;font-weight:bold}
        input,select{width:100%;padding:10px;margin-top:5px;box-sizing:border-box;border:1px solid #ccc;border-radius:5px;}
        button{width:100%;padding:12px;margin-top:20px;background:#28a745;color:#fff;border:none;border-radius:5px}
        .readonly{background:#eee;color:#555;cursor:not-allowed;}
        .admin{border:2px dashed orange;padding:15px;margin-top:30px;display:none;background:#fff3e0;border-radius:10px;}
    </style>
</head>
<body>
    <h3 style="border-bottom:2px solid #eee;padding-bottom:10px;">âš™ï¸ å€‹äººè¨­å®š</h3>
    
    <label>å§“å (å”¯è®€)</label><input type="text" id="name" class="readonly" disabled>
    <label>çµ„åˆ¥ (å”¯è®€)</label><input type="text" id="group" class="readonly" disabled>
    
    <label>è¯çµ¡é›»è©±</label><input type="tel" id="phone" placeholder="ç­ç¨‹å ±åè‡ªå‹•å¸¶å…¥">
    <label>ç”¨é¤ç¿’æ…£</label><select id="meal"><option value="ç´ é£Ÿ">ç´ é£Ÿ</option><option value="è‘·é£Ÿ">è‘·é£Ÿ</option></select>
    <label>æ¯æœˆäº†æ„¿ç›®æ¨™</label><input type="number" id="goal">
    
    <button onclick="save()">ğŸ’¾ å„²å­˜è¨­å®š</button>

    <div id="adminZone" class="admin">
        <h4 style="margin-top:0;color:#e65100;">ğŸ‘‘ å¹¹éƒ¨å°ˆå€</h4>
        <label>æ–°å¢å·¥ä½œé …ç›®</label>
        <div style="display:flex;gap:10px;">
            <input type="text" id="newTask" placeholder="è¼¸å…¥åç¨±">
            <button style="background:orange;width:30%;margin-top:5px;" onclick="addTask()">æ–°å¢</button>
        </div>
    </div>

    <script>
        var LIFF_ID="{{ liff_id }}", uid="";
        window.onload=()=>{
            liff.init({liffId:LIFF_ID}).then(()=>{
                if(!liff.isLoggedIn())liff.login();
                liff.getProfile().then(p=>{
                    uid=p.userId;
                    fetch('/api/profile?user_id='+uid).then(r=>r.json()).then(d=>{
                        if(d.error) return alert('è«‹å…ˆè¨»å†Šæˆ–å®Œæˆç¬¬ä¸€æ¬¡æ‰“å¡');
                        document.getElementById('name').value=d.name;
                        document.getElementById('group').value=d.group;
                        document.getElementById('phone').value=d.phone;
                        document.getElementById('meal').value=d.meal;
                        document.getElementById('goal').value=d.goal;
                        if(["å°çµ„é•·","çµ„é•·","ç®¡ç†å“¡","å€é“å‹™éƒ¨"].includes(d.role)) document.getElementById('adminZone').style.display='block';
                    });
                });
            });
        }
        function save(){
            var d={user_id:uid, phone:document.getElementById('phone').value, meal:document.getElementById('meal').value, goal:document.getElementById('goal').value};
            fetch('/api/profile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)})
            .then(r=>r.json()).then(res=>alert(res.message));
        }
        function addTask(){
            var t=document.getElementById('newTask').value;
            if(!t)return;
            fetch('/api/leader/add_task',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid,task_name:t})})
            .then(r=>r.json()).then(res=>{ alert(res.message); document.getElementById('newTask').value=''; });
        }
    </script>
</body>
</html>