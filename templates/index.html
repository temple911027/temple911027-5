<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å ‚é‹ä½œå°å¹«æ‰‹</title>
    <style>
        body {
            background-color: #f9fafb;
            font-family: sans-serif;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; margin: 0; text-align: center; color: #374151;
        }
        .card {
            background: white; padding: 2rem; border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 320px;
        }
        .icon-box {
            width: 80px; height: 80px; background-color: #dbeafe; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;
            position: relative;
        }
        .loader {
            position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .title { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .subtitle { font-size: 1.25rem; font-weight: bold; color: #1e40af; margin: 0.5rem 0; }
        .desc { color: #3b82f6; margin-bottom: 1.5rem; }
        .status { color: #6b7280; margin-bottom: 1.5rem; }
    </style>

    <!-- [é—œéµå„ªåŒ–] ç«‹å³åŸ·è¡Œè·¯ç”±æª¢æŸ¥ï¼Œå®Œå…¨ä¸ä¾è³´å¤–éƒ¨è³‡æº -->
    <script>
        (function() {
            // 1. å–å¾—ç¶²å€åƒæ•¸
            var urlParams = new URLSearchParams(window.location.search);
            var page = urlParams.get('page');
            var liffState = urlParams.get('liff.state');

            // 2. å˜—è©¦è§£æ liff.state (å¦‚æœ page ä¸å­˜åœ¨)
            if (!page && liffState) {
                try {
                    // è™•ç†å¯èƒ½çš„å¤šé‡ç·¨ç¢¼
                    var decoded = decodeURIComponent(liffState);
                    // ç§»é™¤é–‹é ­çš„ ? (å¦‚æœæœ‰)
                    if (decoded.indexOf('?') === 0) decoded = decoded.substring(1);

                    var stateParams = new URLSearchParams(decoded);
                    page = stateParams.get('page');
                } catch (e) { console.error(e); }
            }

            // 3. å¦‚æœç¢ºå®šè¦è·³è½‰ï¼Œå°‡ç›®æ¨™å­˜å…¥å…¨åŸŸè®Šæ•¸
            if (page && page !== 'index') {
                window.targetPage = page;
            }
        })();
    </script>
</head>
<body>

    <div class="card">
        <div class="icon-box">
            <span style="font-size: 2.5rem;">ğŸ™</span>
            <div class="loader" id="loading-spinner"></div>
        </div>
        <h1 class="title">æ­¡è¿ä½¿ç”¨</h1>
        <h2 class="subtitle">é•·è–ä½›å®®</h2>
        <h3 class="desc">å…¬å ‚é‹ä½œå°å¹«æ‰‹</h3>
        <div class="status" id="status-text">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <script>
        // é é¢é¡¯ç¤ºé‚è¼¯
        var page = window.targetPage;
        var statusText = document.getElementById('status-text');

        function getPageName(p) {
            var map = {
                'checkin': 'äº†æ„¿æ‰“å¡',
                'fix': 'æ•…éšœç”³å ±',
                'query': 'è³‡æ–™æŸ¥è©¢',
                'class_info': 'ç­ç¨‹è³‡è¨Š',
                'help': 'ç³»çµ±èªªæ˜'
            };
            return map[p] || 'åŠŸèƒ½é é¢';
        }

        if (page) {
            // === æƒ…æ³ A: éœ€è¦è·³è½‰ ===
            // é¡¯ç¤ºç›®æ¨™ï¼Œä¸¦ç«‹å³è·³è½‰ï¼Œä¸è¼‰å…¥ LIFF SDK (ç¯€çœæ™‚é–“)
            statusText.innerText = "æ­£åœ¨å‰å¾€ï¼š" + getPageName(page);

            // å»¶é² 100ms è®“ç€è¦½å™¨æœ‰æ©Ÿæœƒæ¸²æŸ“å‡ºä¸Šé¢çš„ HTML æ–‡å­—ï¼Œç„¶å¾Œç«‹åˆ»è·³
            setTimeout(function() {
                window.location.replace('/liff?page=' + page);
            }, 100);

        } else {
            // === æƒ…æ³ B: åœç•™åœ¨é¦–é  (æ²’æœ‰åƒæ•¸) ===
            // é€™æ™‚å€™æ‰éœ€è¦è¼‰å…¥ LIFF SDK
            document.getElementById('loading-spinner').style.display = 'none';
            statusText.innerHTML = "ç³»çµ±å·²å°±ç·’ã€‚<br>è«‹é»é¸ä¸‹æ–¹é¸å–®æ“ä½œã€‚";

            // å‹•æ…‹è¼‰å…¥ LIFF SDK (ä¸é˜»å¡)
            var script = document.createElement('script');
            script.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
            script.onload = function() {
                var liffId = "{{ liff_id }}";
                if(typeof liff !== 'undefined' && liffId) {
                    liff.init({ liffId: liffId }).catch(err => console.error(err));
                }
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>