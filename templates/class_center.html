<!DOCTYPE html>
<html>
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…§éœ–å®®ç­ç¨‹ä¸­å¿ƒ</title> <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body{font-family:"Microsoft JhengHei",sans-serif;padding:15px;background:#fdfbf7;color:#5d4037;}
        .header-btn {background:#fff; border:2px solid #e6d0a5; color:#8d6e63; width:100%; padding:15px; border-radius:10px; font-weight:bold; margin-bottom:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;}
        .card{background:#fff;padding:15px;margin-bottom:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05); border-left:5px solid #e6d0a5;}
        button{width:100%;padding:10px;background:#e6d0a5;color:#5d4037;border:none;border-radius:5px;margin-top:10px;font-weight:bold;cursor:pointer;}
        .hidden{display:none}
        .tab-bar{display:flex;margin-bottom:15px}
        .tab{flex:1;text-align:center;padding:10px;background:#eee;cursor:pointer;color:#aaa}
        .tab.active{background:#e6d0a5;color:#5d4037}
    </style>
</head>
<body>
    <div class="header-btn" onclick="location.href='https://liff.line.me/{{ liff_id }}?page=class_info'">
        <span>ğŸ“… æŸ¥çœ‹æœ¬æœˆè¡Œäº‹æ›†/èª²è¡¨</span>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('list')">è¿‘æœŸç­ç¨‹</div>
        <div class="tab" onclick="switchTab('my')">æˆ‘çš„å ±å</div>
    </div>

    <div id="listMode">è¼‰å…¥ä¸­...</div>
    <div id="myMode" class="hidden"></div>

    <div id="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center">
        <div style="background:#fff;padding:25px;width:80%;border-radius:12px;text-align:center;">
            <h3 id="mTitle" style="color:#5d4037"></h3>
            <p style="color:#888;font-size:0.9rem;background:#f9f9f9;padding:10px;">ç³»çµ±å°‡è‡ªå‹•å¸¶å…¥æ‚¨çš„å€‹è³‡ (å§“å/é›»è©±/ç´ é£Ÿ)</p>
            <input type="text" id="mNote" placeholder="å‚™è¨» (é¸å¡«)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin:10px 0;">
            <button onclick="doSignup()">ç¢ºèªå ±å</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="background:#ddd;color:#888">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        var LIFF_ID="{{ liff_id }}", uid="", curClass={};
        window.onload=()=>{
            liff.init({liffId:LIFF_ID}).then(()=>{
                if(!liff.isLoggedIn())liff.login();
                liff.getProfile().then(p=>{ uid=p.userId; loadData(); });
            });
        }
        function switchTab(t){
            document.getElementById('listMode').classList.toggle('hidden',t!='list');
            document.getElementById('myMode').classList.toggle('hidden',t!='my');
            if(t=='my') loadMy();
        }
        function loadData(){
            fetch('/api/classes').then(r=>r.json()).then(d=>{
                var h='';
                if(!d||d.length==0) h='<div style="text-align:center;color:#aaa">æš«ç„¡ç­ç¨‹</div>';
                else d.forEach(c=>{
                    h+=`<div class="card"><b>${c.name}</b><br><small>ğŸ“… ${c.date}</small>
                    <button onclick="openModal('${c.name}','${c.date}')">ç«‹å³å ±å</button></div>`;
                });
                document.getElementById('listMode').innerHTML=h;
            });
        }
        function loadMy(){
            fetch('/api/my_signups?user_id='+uid).then(r=>r.json()).then(d=>{
                var h='';
                if(!d||d.length==0) h='<div style="text-align:center;color:#aaa">ç„¡å ±åç´€éŒ„</div>';
                else d.forEach(c=>{
                    h+=`<div class="card" style="border-left-color:#8bc34a"><b>${c.name}</b><br><small>${c.date}</small>
                    <button style="background:#ffccbc" onclick="cancel('${c.name}')">å–æ¶ˆå ±å</button></div>`;
                });
                document.getElementById('myMode').innerHTML=h;
            });
        }
        function openModal(n,d){ curClass={name:n,date:d}; document.getElementById('mTitle').innerText=n; document.getElementById('modal').style.display='flex'; }
        function doSignup(){
            var btn=document.querySelector('#modal button'); btn.disabled=true; btn.innerText="è™•ç†ä¸­...";
            fetch('/api/register_class',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid,class_name:curClass.name,class_date:curClass.date,note:document.getElementById('mNote').value})})
            .then(r=>r.json()).then(res=>{ alert(res.message); if(res.success)document.getElementById('modal').style.display='none'; btn.disabled=false; btn.innerText="ç¢ºèªå ±å"; });
        }
        function cancel(n){
            if(confirm('ç¢ºå®šå–æ¶ˆ?')) fetch('/api/cancel_registration',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid,class_name:n})})
            .then(r=>r.json()).then(res=>{ alert(res.message); loadMy(); });
        }
    </script>
</body>
</html>
